USE [EDG_DMMR]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE OR ALTER PROCEDURE [LOG].[sp_Get_SchemaFailPass_DQ]
AS
BEGIN
    SET NOCOUNT ON;
    
    ;WITH LatestRun AS
    (
        SELECT MAX(DQ_AS_OF_DATE) AS MaxAsOfDate
        FROM [Log].[Data_Quality]
    )
    SELECT
        -- Extract Schema from Schema.Table (everything before the period)
        LEFT(DQ_Table, CHARINDEX('.', DQ_Table) - 1) AS SchemaName,
        
        -- Extract Table from Schema.Table (everything after the period)
        SUBSTRING(DQ_Table, CHARINDEX('.', DQ_Table) + 1, LEN(DQ_Table)) AS TableName,
        
        -- Passed checks (DQ_Failed = 'N')
        SUM(CASE
                WHEN DQ_Failed = 'N'
                THEN 1
                ELSE 0
            END) AS PassedCount,
        
        -- Failed checks (DQ_Failed = 'Y')
        SUM(CASE
                WHEN DQ_Failed = 'Y'
                THEN 1 
                ELSE 0
            END) AS FailedCount,
        
        -- Failed check details (only if failed)
        STRING_AGG(
            CASE WHEN DQ_Failed = 'Y' THEN DQ_Check END, 
            '; '
        ) WITHIN GROUP (ORDER BY DQ_Check) AS Failed_Checks
        
    FROM [LOG].[Data_Quality] dq
    CROSS JOIN LatestRun lr
    WHERE dq.DQ_AS_OF_DATE = lr.MaxAsOfDate
        AND CHARINDEX('.', dq.DQ_Table) > 0
    GROUP BY
        LEFT(DQ_Table, CHARINDEX('.', DQ_Table) - 1),
        SUBSTRING(DQ_Table, CHARINDEX('.', DQ_Table) + 1, LEN(DQ_Table))
    ORDER BY
        FailedCount DESC;
END;
GO
