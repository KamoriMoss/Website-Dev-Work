Imports System.Data
Imports System.Data.SqlClient
Imports System.Web.UI.DataVisualization.Charting

Partial Public Class Data_Quality_Dashboard
    Inherits System.Web.UI.Page
    Protected schemaJson As String = "[]"

    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
        cs.DoLogin()
        If Not IsPostBack Then
            myDQ.SetActiveView(myboard)

            ' Retrieve KPI Values
            Dim totalRecords As Long = GetTotalRecords()
            Dim totalTables As Integer = GetTotalTables()
            Dim totalSchemas As Integer = GetTotalSchemas()

            ' Bind KPI Labels (IDs must match ASPX)
            lblTotalRecords.Text = totalRecords.ToString("N0")
            lblTotalTables.Text = totalTables.ToString("N0")
            lblTotalSchemas.Text = totalSchemas.ToString("N0")

            schemaJson = GetSchemaJson()

            ' Build metrics table and chart
            BuildMetricsTable(totalRecords, totalTables, totalSchemas)

        End If
    End Sub

    Private Sub BuildMetricsTable(totalRecords As Long, totalTables As Integer, totalSchemas As Integer)
        Table1.Rows.Clear()

        ' Header
        Dim hdr As New TableRow()
        hdr.Cells.Add(New TableCell() With {.Text = "<b>Metric</b>"})
        hdr.Cells.Add(New TableCell() With {.Text = "<b>Value</b>"})
        Table1.Rows.Add(hdr)

        ' Live Counts
        Dim failedNCount As Integer = GetFailedNCount()
        Dim passedYCount As Integer = GetPassedYCount()

        ' Example Static rows (keep or replace with your real computations)
        Dim r1 As New TableRow()
        r1.Cells.Add(New TableCell() With {.Text = "Passed"})
        r1.Cells.Add(New TableCell() With {.Text = "97.3%"})
        Table1.Rows.Add(r1)

        Dim r2 As New TableRow()
        r2.Cells.Add(New TableCell() With {.Text = "Failed"})
        r2.Cells.Add(New TableCell() With {.Text = "2.7%"})
        Table1.Rows.Add(r2)

        Dim r3 As New TableRow()
        r3.Cells.Add(New TableCell() With {.Text = "Passed = ((Count))"})
        r3.Cells.Add(New TableCell() With {.Text = passedYCount.ToString("N0")})
        Table1.Rows.Add(r3)

        Dim r4 As New TableRow()
        r4.Cells.Add(New TableCell() With {.Text = "Failed = ((Count))"})
        r4.Cells.Add(New TableCell() With {.Text = failedNCount.ToString("N0")})
        Table1.Rows.Add(r4)

        ' KPI Rows
        Dim k1 As New TableRow()
        k1.Cells.Add(New TableCell() With {.Text = "<b>Total Tables</b>"})
        k1.Cells.Add(New TableCell() With {.Text = totalTables.ToString("N0")})
        Table1.Rows.Add(k1)

        Dim k2 As New TableRow()
        k2.Cells.Add(New TableCell() With {.Text = "<b>Total Records</b>"})
        k2.Cells.Add(New TableCell() With {.Text = totalRecords.ToString("N0")})
        Table1.Rows.Add(k2)

        Dim k3 As New TableRow()
        k3.Cells.Add(New TableCell() With {.Text = "<b>Total Schemas</b>"})
        k3.Cells.Add(New TableCell() With {.Text = totalSchemas.ToString("N0")})
        Table1.Rows.Add(k3)

    End Sub

    Private Function GetTotalRecords() As Long
        Using conn As SqlConnection = db.GetSQLConn(0)
            Using cmd As New SqlCommand("LOG.sp_Get_TotalRecords_DQ", conn)
                cmd.CommandType = CommandType.StoredProcedure
                Try
                    conn.Open()
                    Return Convert.ToInt64(cmd.ExecuteScalar())
                Finally
                    conn.Close()
                End Try
            End Using
        End Using
    End Function

    Private Function GetTotalTables() As Integer
        Using conn As SqlConnection = db.GetSQLConn(0)
            Using cmd As New SqlCommand("LOG.sp_Get_TotalTables_DQ", conn)
                cmd.CommandType = CommandType.StoredProcedure
                Try
                    conn.Open()
                    Return Convert.ToInt32(cmd.ExecuteScalar())
                Finally
                    conn.Close()
                End Try
            End Using
        End Using
    End Function

    Private Function GetTotalSchemas() As Integer
        Using conn As SqlConnection = db.GetSQLConn(0)
            Using cmd As New SqlCommand("LOG.sp_Get_TotalSchemas_DQ", conn)
                cmd.CommandType = CommandType.StoredProcedure
                Try
                    conn.Open()
                    Return Convert.ToInt32(cmd.ExecuteScalar())
                Finally
                    conn.Close()
                End Try
            End Using
        End Using
    End Function

    Private Function GetSchemaJson() As String
        Dim list As New List(Of Dictionary(Of String, Object))()

        Using conn As SqlConnection = db.GetSQLConn(0)
            Using cmd As New SqlCommand("LOG.sp_Get_SchemaRowCounts_DQ", conn)
                cmd.CommandType = CommandType.StoredProcedure
                Try
                    conn.Open()

                    Using rdr As SqlDataReader = cmd.ExecuteReader()
                        While rdr.Read()
                            Dim row As New Dictionary(Of String, Object)()
                            row("Schema") = rdr("SchemaName").ToString()
                            row("RowCount") = Convert.ToInt32(rdr("RowCount"))
                            list.Add(row)
                        End While
                    End Using
                Finally
                    conn.Close()
                End Try
            End Using
        End Using

        Return New System.Web.Script.Serialization.JavaScriptSerializer().Serialize(list)
    End Function

    Private Function GetFailedNCount() As Integer
        Using conn As SqlConnection = db.GetSQLConn(0)
            Using cmd As New SqlCommand("LOG.sp_Get_FailedNCount_DQ", conn)
                cmd.CommandType = CommandType.StoredProcedure
                Try
                    conn.Open()
                    Return Convert.ToInt32(cmd.ExecuteScalar())
                Finally
                    conn.Close()
                End Try
            End Using
        End Using
    End Function

    Private Function GetPassedYCount() As Integer
        Using conn As SqlConnection = db.GetSQLConn(0)
            Using cmd As New SqlCommand("LOG.sp_Get_PassedYCount_DQ", conn)
                cmd.CommandType = CommandType.StoredProcedure
                Try
                    conn.Open()
                    Return Convert.ToInt32(cmd.ExecuteScalar())
                Finally
                    conn.Close()
                End Try
            End Using
        End Using
    End Function

End Class
               


